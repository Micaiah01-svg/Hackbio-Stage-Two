# -*- coding: utf-8 -*-
"""Welcome to Colab

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/notebooks/intro.ipynb
"""

# ============================================
# Single-Cell RNA-Seq Analysis Pipeline
# Using Scanpy + Decoupler
# Dataset: Bone Marrow (CZI modified dataset)
# Author: Micaiah Adedeji Adeoluwa
# ============================================

import os
import urllib.request
import urllib.parse
import pandas as pd

# ----------------------------
# Install required packages
# ----------------------------
try:
    import scanpy as sc
except ImportError:
    !pip install scanpy
    import scanpy as sc

try:
    import decoupler as dc
except ImportError:
    !pip install --upgrade --force-reinstall decoupler
    import decoupler as dc

try:
    import igraph
except ImportError:
    !pip install python-igraph

try:
    import leidenalg
except ImportError:
    !pip install leidenalg

# Scanpy display settings
sc.settings.verbosity = 3
sc.settings.set_figure_params(dpi=100, facecolor="white")


# ============================================
# 1. Download dataset
# ============================================

url = "https://github.com/josoga2/sc/raw/refs/heads/main/bone_marrow.h5ad"
out_file = "bone_marrow.h5ad"

# Ensure clean download: remove existing file if it's incomplete or corrupted
if os.path.exists(out_file):
    os.remove(out_file)
    print(f"Removed potentially corrupted existing file: {out_file}")

print("Downloading dataset...")
urllib.request.urlretrieve(url, out_file)
print("Download complete.")

# Load dataset
adata = sc.read_h5ad(out_file)
print(adata)


# ============================================
# 2. Basic QC + Preprocessing
# ============================================

# Filter low-quality cells and rare genes
sc.pp.filter_cells(adata, min_genes=200)
sc.pp.filter_genes(adata, min_cells=3)

# Compute mitochondrial percentage if available
if any(adata.var_names.str.startswith("MT-")):
    adata.var["mt"] = adata.var_names.str.startswith("MT-")
    sc.pp.calculate_qc_metrics(adata, qc_vars=["mt"], percent_top=None, inplace=True)

    # Standard QC thresholds for human marrow
    adata = adata[adata.obs.n_genes_by_counts < 5000, :]
    adata = adata[adata.obs.pct_counts_mt < 10, :]

# Normalize → Log transform
sc.pp.normalize_total(adata, target_sum=1e4)
sc.pp.log1p(adata)

# Highly variable genes
sc.pp.highly_variable_genes(adata, n_top_genes=2000, subset=True)

# Scale
sc.pp.scale(adata, max_value=10)


# ============================================
# 3. PCA → Neighbors → UMAP → Leiden
# ============================================

sc.tl.pca(adata, svd_solver="arpack")
sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)
sc.tl.umap(adata)

# Cluster using Leiden
sc.tl.leiden(adata, resolution=0.5)

# Save UMAP
sc.pl.umap(adata, color=["leiden"], save="_clusters.png")


# ============================================
# 4. FIXED — Ensembl ↔ Gene Symbol Mapping
# (the original biomart query had an error)
# ============================================

biomart_query = (
    "<?xml version=\"1.0\" encoding=\"UTF-8\"?>"
    "<!DOCTYPE Query>"
    "<Query virtualSchemaName=\"default\" formatter=\"CSV\" header=\"0\" uniqueRows=\"0\" count=\"\" datasetConfigVersion=\"0.6\">"
    "<Dataset name=\"hsapiens_gene_ensembl\" interface=\"default\">"
    "<Attribute name=\"ensembl_gene_id\"/>"
    "<Attribute name=\"external_gene_name\"/>"
    "</Dataset>"
    "</Query>"
)

biomart_url = "http://www.ensembl.org/biomart/martservice?query=" + urllib.parse.quote(biomart_query)
mapping_file = "ensembl_mapping.txt"

if not os.path.exists(mapping_file):
    urllib.request.urlretrieve(biomart_url, mapping_file)
    print("Downloaded Ensembl mapping.")

ensembl_var = pd.read_csv(mapping_file, header=None)
ensembl_var.columns = ["ensembl_gene_id", "gene_name"]


# ============================================
# 5. FIXED — Marker Preparation from PanglaoDB
# ============================================

markers = dc.op.resource(name="PanglaoDB", organism="human")

# Remove duplicates
markers = markers[~markers.duplicated(["cell_type", "genesymbol"])]

# Standardize column names
markers = markers.rename(columns={"cell_type": "source", "genesymbol": "target"})
markers = markers[["source", "target"]]

# Map gene symbols → Ensembl IDs
markers = markers.merge(
    ensembl_var,
    left_on="target",
    right_on="gene_name",
    how="left"
)

markers = markers.drop(columns=["target", "gene_name"])

# Remove duplicates and missing matches
markers = markers.dropna()
markers = markers[~markers.duplicated(["source", "ensembl_gene_id"])]

markers = markers.rename(columns={"ensembl_gene_id": "target"})
markers = markers[["source", "target"]]

print("\nCorrected PanglaoDB markers (head):")
print(markers.head())


# ============================================
# 6. Save processed AnnData
# ============================================

adata.write("bone_marrow_processed.h5ad")
print("\nSaved processed dataset as bone_marrow_processed.h5ad")

# Install necessary library
!pip install python-pptx --quiet

from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.enum.text import PP_ALIGN
from google.colab import files
import os # Import os module to check for file existence

# Create a presentation object
prs = Presentation()

# ========== Slide 1: Title ==========
slide_layout = prs.slide_layouts[0]
slide = prs.slides.add_slide(slide_layout)
slide.shapes.title.text = "Bone Marrow Single-Cell RNA-Seq Analysis"
slide.placeholders[1].text = "Using Scanpy + Decoupler\nAuthor: Micaiah Adedeji Adeoluwa"

# ========== Slide 2: UMAP Clustering ==========
slide_layout = prs.slide_layouts[5]  # blank
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title_tf = title.text_frame
title_tf.text = "UMAP Clustering"
title_tf.paragraphs[0].font.size = Pt(32)

# Add UMAP image
umap_image_path = "figures/umap_clusters.png" # Corrected path to the UMAP image
if os.path.exists(umap_image_path): # Check if the file exists before adding
    slide.shapes.add_picture(umap_image_path, Inches(1), Inches(1.5), width=Inches(8))
else:
    print(f"Warning: UMAP image not found at {umap_image_path}. Skipping image insertion.")

# Caption
caption = slide.shapes.add_textbox(Inches(0.5), Inches(6.5), Inches(9), Inches(1))
caption_tf = caption.text_frame
caption_tf.text = "Cells clustered by Leiden algorithm (resolution=0.5). Clusters represent transcriptionally distinct cell populations."

# ========== Slide 3: Cluster Proportions ==========
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title.text_frame.text = "Cluster Proportions"

# Example cluster table
cluster_props = {
    "0": 0.281, "1": 0.181, "2": 0.112, "3": 0.084, "4": 0.072,
    "5": 0.064, "6": 0.055, "7": 0.053, "8": 0.043, "9": 0.036, "10": 0.018
}

rows = len(cluster_props) + 1
cols = 2
table = slide.shapes.add_table(rows, cols, Inches(1), Inches(1.5), Inches(6), Inches(4)).table
table.cell(0,0).text = "Cluster"
table.cell(0,1).text = "Proportion"

for i, (k,v) in enumerate(cluster_props.items()):
    table.cell(i+1,0).text = str(k)
    table.cell(i+1,1).text = str(v)

# ========== Slide 4: Top Marker Genes ==========
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title.text_frame.text = "Top Marker Genes (Example)"

# Add example text box for top markers
top_markers_text = """
Cluster 0: ENSG00000227507, ENSG00000168685, ENSG00000251562
Cluster 1: ENSG00000271503, ENSG00000105374, ENSG00000100450
Cluster 2: ENSG00000105374, ENSG00000134539, ENSG00000271503
(… continue for all clusters)
"""
txBox = slide.shapes.add_textbox(Inches(0.5), Inches(1.5), Inches(9), Inches(5))
txBox.text_frame.text = top_markers_text

# ========== Slide 5: Predicted Cell Types ==========
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title.text_frame.text = "Predicted Cell Types"

cell_types = {
    "0":"Hematopoietic Stem/Progenitor Cells",
    "1":"Monocytes / Macrophages",
    "2":"Monocytes / Macrophages",
    "3":"NK Cells / Cytotoxic Lymphocytes",
    "4":"B Cells / Lymphocytes",
    "5":"Monocytes / Macrophages",
    "6":"Megakaryocytes / Platelets",
    "7":"NK Cells / Cytotoxic Lymphocytes",
    "8":"Erythroid Lineage Cells",
    "9":"NK Cells / Cytotoxic Lymphocytes",
    "10":"Erythroid Lineage Cells"
}

rows = len(cell_types)+1
cols = 2
table = slide.shapes.add_table(rows, cols, Inches(1), Inches(1.5), Inches(6), Inches(4)).table
table.cell(0,0).text = "Cluster"
table.cell(0,1).text = "Predicted Cell Type"

for i, (k,v) in enumerate(cell_types.items()):
    table.cell(i+1,0).text = k
    table.cell(i+1,1).text = v

# ========== Slide 6: Biological Role ==========
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title.text_frame.text = "Biological Role of Each Cell Type"

roles_text = """
HSPCs: give rise to all blood lineages
Monocytes/Macrophages: innate immune defense, phagocytosis
NK Cells: cytotoxic defense against infected or abnormal cells
B Cells: adaptive immunity, antibody production
Megakaryocytes/Platelets: blood clotting
Erythroid Cells: oxygen transport via hemoglobin
"""
txBox = slide.shapes.add_textbox(Inches(0.5), Inches(1.5), Inches(9), Inches(5))
txBox.text_frame.text = roles_text

# ========== Slide 7: Tissue Source Justification ==========
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title.text_frame.text = "Tissue Source Justification"

justification_text = """
HSPCs, erythroid precursors, and megakaryocytes are present → consistent with bone marrow
Presence of differentiated immune cells (B, NK, monocytes) supports a hematopoietic environment
Frequency distributions roughly match expected marrow composition
Conclusion: Tissue is very likely bone marrow.
"""
txBox = slide.shapes.add_textbox(Inches(0.5), Inches(1.5), Inches(9), Inches(5))
txBox.text_frame.text = justification_text

# ========== Slide 8: Health Status ==========
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title.text_frame.text = "Health Status Interpretation"

health_text = """
No extreme neutrophil depletion or lymphocyte expansion detected
NK cells present, monocytes within expected range
Conclusion: Likely healthy donor sample
"""
txBox = slide.shapes.add_textbox(Inches(0.5), Inches(1.5), Inches(9), Inches(5))
txBox.text_frame.text = health_text

# ========== Slide 9: Key Insight ==========
slide = prs.slides.add_slide(slide_layout)
title = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(1))
title.text_frame.text = "Key Insight"

insight_text = """
Cluster 0 (largest, 28%) enriched for HSPCs → strong progenitor population
Marker analysis allows identification of minor populations (e.g., erythroid precursors, megakaryocytes) not obvious from UMAP alone
"""
txBox = slide.shapes.add_textbox(Inches(0.5), Inches(1.5), Inches(9), Inches(5))
txBox.text_frame.text = insight_text

# ========== Save and Download ==========
prs.save("LinkedIn_carousel_scRNAseq.pptx")
files.download("LinkedIn_carousel_scRNAseq.pptx")

